name: Taweret test and deploy

on:
  pull_request:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test:
   strategy:
     matrix:
       os: [ubuntu-20.04, ubuntu-22.04, macos-12, macos-13]
       python-version: ["3.9", "3.10", "3.11", "3.12"]
   runs-on: ${{ matrix.os }}
   env:
     CLONE_PATH:  ${{ github.workspace }}
   steps:
     - uses: actions/checkout@v4 
     - name: Setup python ${{ matrix.python-version }}
       uses: actions/setup-python@v5
       with:
         python-version: ${{ matrix.python-version }}
     - name: Install dependencies
       run: |
         python -m pip install --upgrade pip
         python -m pip install --upgrade setuptools
         python -m pip install build
         echo " "
         python -m build
         ls dist
         echo " "
         pip install -e $CLONE_PATH
         echo " "
         which python
         which pip
         python --version
         echo " "
         python -c "import platform ; print(platform.machine())"
         python -c "import platform ; print(platform.system())"
         python -c "import platform ; print(platform.release())"
         python -c "import platform ; print(platform.platform())"
         python -c "import platform ; print(platform.version())"
         if [ "${{ matrix.os }}" = "macos-latest" ]; then
             python -c "import platform ; print(platform.mac_ver())"
         fi
         echo " "
         pip list
     - name: Run pytests without coverage (Linux)
       if: runner.os == 'Linux'
       run: |
         wget https://download.open-mpi.org/release/open-mpi/v4.0/openmpi-4.0.2.tar.gz
         tar -xvf ./openmpi-4.0.2.tar.gz
         ./openmpi-4.0.2/configure --prefix="/home/${USER}/.openmpi"
         make -j
         make install
         export PATH=${PATH}:/home/${USER}/.openmpi/bin/
         export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/home/${USER}/.openmpi/lib/
         which mpirun
         pushd $pythonLocation/lib/python${{ matrix.python-version }}/site-packages/openbtmixing/.libs
         #ls openbt*
         ldd openbtcli
         popd
         pushd $CLONE_PATH
         pytest test/
         popd
     - name: Run pytest without coverage (MacOS)
       if: runner.os == 'macOS'
       run: |
         /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
         brew install open-mpi
         which mpirun
         pushd $pythonLocation/lib/python${{ matrix.python-version }}/site-packages/openbtmixing/.libs
         #ls openbt*
         otool -L openbtcli
         popd
         pip show openbtmixing
         pushd $CLONE_PATH
         pytest test/
         popd

  coverage:
   strategy:
     matrix:
       os: [ubuntu-latest]
       python-version: ["3.12"]
   runs-on: ${{ matrix.os }}
   env:
     CLONE_PATH:  ${{ github.workspace }}
   steps:
     - uses: actions/checkout@v4 
     - name: Setup python ${{ matrix.python-version }}
       uses: actions/setup-python@v5
       with:
         python-version: ${{ matrix.python-version }}
     - name: Install dependencies
       run: |
         python -m pip install --upgrade pip
         python -m pip install --upgrade setuptools
         pip install -e $CLONE_PATH
     - name: Run pytests with coverage
       run: |
         wget https://download.open-mpi.org/release/open-mpi/v4.0/openmpi-4.0.2.tar.gz
         tar -xvf ./openmpi-4.0.2.tar.gz
         ./openmpi-4.0.2/configure --prefix="/home/${USER}/.openmpi"
         make -j
         make install
         export PATH=${PATH}:/home/${USER}/.openmpi/bin/
         export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/home/${USER}/.openmpi/lib/
         pushd $CLONE_PATH
         pytest --cov=Taweret test
         popd
     - name: Upload coverage reports to Codecov
       uses: codecov/codecov-action@v4.0.1
       with:
         token: ${{ secrets.KEVIN_CODECOV_TOKEN }}
         slug: bandframework/Taweret

#  deploy:
#    runs-on: ubuntu-latest
#    needs: [test]
#    if: ${{ always() && contains(join(needs.*.result, ','), 'success') }}
#    environment:
#      name: pypi
#      url: https://pypi.org/p/Taweret
#    permissions:
#      id-token: write
#    steps:
#      - uses: actions/checkout@v4
#      - name: Setup pyhton
#        uses: actions/setup-python@v4
#        with:
#          python-version: '3.10'
#      - name: Install dependencies
#        run: |
#          python -m pip install --upgrade pip
#          pip install build
#          pip install -e .
#      - name: Update directory structure 
#        run: |
#          mv Taweret src
#      - name: Update pyproject.toml
#        run: |
#          sed -i '/start-delete/,/stop-delete/d' pyproject.toml
#      - name: Build package
#        run: python -m build
#      - name: Publish package
#        uses: pypa/gh-action-pypi-publish@release/v1
