name: Taweret test and deploy

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test:
   #####----- RUN FULL TEST SUITE WITHOUT COVERAGE
   # Test through actual installations for correct pre-deployment end-to-end
   # tests.
   strategy:
     matrix:
       os: [ubuntu-20.04, ubuntu-22.04, macos-12, macos-13, macos-latest]
       python-version: ["3.9", "3.10", "3.11", "3.12"]
   runs-on: ${{ matrix.os }}
   env:
     CLONE_PATH:  ${{ github.workspace }}
   steps:
     - uses: actions/checkout@v4 
     - name: Setup python ${{ matrix.python-version }}
       uses: actions/setup-python@v5
       with:
         python-version: ${{ matrix.python-version }}
     - name: Install OpenMPI
       run: |
         if   [ "${{ runner.os }}" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get -y install openmpi-bin
         elif [ "${{ runner.os }}" == "macOS" ]; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            brew install open-mpi
         fi
     - name: Setup base Python environment
       run: |
         $CLONE_PATH/.github/workflows/setup_base_python.sh ${{ matrix.os }}
     - name: Run pytests without coverage
       run: |
         pushd $CLONE_PATH
         tox -r -e nocoverage
         popd

  deploy:
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.12"]
    runs-on: ${{ matrix.os }}
    needs: [test]
    if: ${{ always() && contains(join(needs.*.result, ','), 'success') }}
    environment:
      name: pypi
      url: https://pypi.org/p/Taweret
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Build distributions
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          python -m pip install build
          python -m build
      - name: Publish package
        uses: pypa/gh-action-pypi-publish@release/v1
